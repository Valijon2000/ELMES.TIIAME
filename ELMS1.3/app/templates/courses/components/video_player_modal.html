{# Video Player Modal Component #}

<!-- Video Modal -->
<div id="video-modal"
    class="fixed inset-0 z-[60] hidden bg-black/95 backdrop-blur-md items-center justify-center transition-all duration-300">
    <!-- Close Button -->
    <button onclick="closeVideoModal()"
        class="absolute top-6 right-6 z-[70] p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors group">
        <svg class="w-8 h-8 group-hover:rotate-90 transition-transform" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>

    <div class="w-full max-w-6xl mx-auto px-4 flex flex-col justify-center h-full relative">
        <!-- Header: Title and Stats -->
        <div class="flex items-center justify-between text-white mb-6">
            <h2 class="text-2xl font-bold line-clamp-1">{{ lesson.title }}</h2>

            {% if current_user.role == 'student' %}
            <div class="flex items-center gap-4 shrink-0">
                <div
                    class="flex items-center gap-2 px-3 py-1.5 bg-blue-500/20 text-blue-300 rounded-full text-sm font-medium border border-blue-500/30">
                    Tekshiruv: <span id="check-counter-modal">{{ lesson_view.attention_checks_passed if lesson_view else
                        0 }}/3</span>
                </div>
                <div id="completion-badge-modal"
                    class="{% if lesson_view and lesson_view.is_completed %}flex{% else %}hidden{% endif %} items-center gap-2 px-3 py-1.5 bg-green-500/20 text-green-400 rounded-full text-sm font-medium border border-green-500/30">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    To'liq ko'rilgan
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Video Container -->
        <div class="relative bg-black rounded-2xl overflow-hidden shadow-2xl ring-1 ring-white/10" id="video-container">
            {% if lesson.video_file %}
            <video id="video-player" class="w-full aspect-video" {% if current_user.role=='student' and not (lesson_view
                and lesson_view.is_completed) %}controlsList="nodownload noremoteplayback nofullscreen"
                oncontextmenu="return false;" {% else %}controls{% endif %}>
                <source src="{{ url_for('courses.serve_video', filename=lesson.video_file) }}" type="video/mp4">
                Brauzeringiz video tegini qo'llab-quvvatlamaydi.
            </video>
            {% if current_user.role == 'student' and not (lesson_view and lesson_view.is_completed) %}
            <!-- Custom controls for first-time viewing -->
            <div id="custom-controls"
                class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                <div class="flex items-center gap-4">
                    <button id="play-pause-btn"
                        class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors">
                        <svg id="play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                        <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                        </svg>
                    </button>
                    <div class="flex-1">
                        <div class="text-white text-sm mb-1">
                            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div id="progress-bar" class="bg-primary-500 h-2 rounded-full transition-all"
                                style="width: 0%">
                            </div>
                        </div>
                    </div>
                    <button id="volume-btn"
                        class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors">
                        <svg id="volume-on-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                        </svg>
                        <svg id="volume-off-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z" />
                        </svg>
                        <button id="fullscreen-btn" onclick="toggleFullscreen()"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors ml-2">
                            <svg id="fullscreen-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                            </svg>
                            <svg id="exit-fullscreen-icon" class="w-6 h-6 hidden" fill="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z" />
                            </svg>
                        </button>
                </div>
            </div>
            {% endif %}
            {% elif lesson.video_url %}
            <!-- YouTube yoki boshqa embed -->
            {% set video_id = '' %}
            {% if 'youtube.com/watch?v=' in lesson.video_url %}
            {% set video_id = lesson.video_url.split('v=')[1].split('&')[0] %}
            {% elif 'youtu.be/' in lesson.video_url %}
            {% set video_id = lesson.video_url.split('/')[-1].split('?')[0] %}
            {% elif 'youtube.com/embed/' in lesson.video_url %}
            {% set video_id = lesson.video_url.split('/')[-1].split('?')[0] %}
            {% endif %}
            <div class="aspect-video relative">
                <iframe id="youtube-player" class="w-full h-full"
                    src="https://www.youtube.com/embed/{{ video_id }}?enablejsapi=1&fs=0{% if current_user.role == 'student' and not (lesson_view and lesson_view.is_completed) %}&disablekb=1&controls=0&modestbranding=1&rel=0&iv_load_policy=3{% else %}&disablekb=0{% endif %}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"></iframe>
                {% if current_user.role == 'student' and not (lesson_view and lesson_view.is_completed) %}
                <!-- YouTube Overlay for Click-to-Play/Pause -->
                <div onclick="toggleYouTubePlay()" class="absolute inset-0 z-[5] cursor-pointer"></div>
                <!-- Custom controls for YouTube first-time viewing -->
                <div id="youtube-custom-controls"
                    class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                    <div class="flex items-center gap-4">
                        <button id="youtube-play-pause-btn"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors">
                            <svg id="youtube-play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                            <svg id="youtube-pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                            </svg>
                        </button>
                        <div class="flex-1">
                            <div class="text-white text-sm mb-1">
                                <span id="youtube-current-time">0:00</span> / <span id="youtube-total-time">0:00</span>
                            </div>
                            <div class="w-full bg-white/20 rounded-full h-2">
                                <div id="youtube-progress-bar" class="bg-primary-500 h-2 rounded-full transition-all"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <button id="youtube-volume-btn"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors">
                            <svg id="youtube-volume-on-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                            </svg>
                            <svg id="youtube-volume-off-icon" class="w-6 h-6 hidden" fill="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z" />
                            </svg>
                        </button>
                        <button id="youtube-fullscreen-btn" onclick="toggleFullscreen()"
                            class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors ml-2">
                            <svg id="youtube-fullscreen-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                            </svg>
                            <svg id="youtube-exit-fullscreen-icon" class="w-6 h-6 hidden" fill="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <video id="video-player" class="w-full aspect-video" {% if current_user.role=='student' and not (lesson_view
                and lesson_view.is_completed) %}controlsList="nodownload noremoteplayback nofullscreen"
                oncontextmenu="return false;" {% else %}controls{% endif %}>
                <source src="{{ lesson.video_url }}">
                Brauzeringiz video tegini qo'llab-quvvatlamaydi.
            </video>
            {% if current_user.role == 'student' and not (lesson_view and lesson_view.is_completed) %}
            <div id="custom-controls"
                class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
                <div class="flex items-center gap-4">
                    <button id="play-pause-btn"
                        class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors">
                        <svg id="play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                        <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                        </svg>
                    </button>
                    <div class="flex-1">
                        <div class="text-white text-sm mb-1">
                            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div id="progress-bar" class="bg-primary-500 h-2 rounded-full transition-all"
                                style="width: 0%">
                            </div>
                        </div>
                    </div>
                    <button id="volume-btn"
                        class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors">
                        <svg id="volume-on-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                        </svg>
                        <svg id="volume-off-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                        </svg>
                    </button>
                    <button id="fullscreen-btn" onclick="toggleFullscreen()"
                        class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center text-white transition-colors ml-2">
                        <svg id="fullscreen-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                        </svg>
                        <svg id="exit-fullscreen-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z" />
                        </svg>
                    </button>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Attention Check Modal (Moved outside for all video types) -->
            <div id="attention-modal"
                class="absolute inset-0 bg-black/70 backdrop-blur-sm z-[80] hidden items-center justify-center">
                <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md mx-4 transform scale-100 animate-bounce-in">
                    <div class="text-center">
                        <div
                            class="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center animate-pulse">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">DIQQAT TEKSHIRUVI!</h2>
                        <p class="text-gray-500 mb-6">Video darsni ko'ryapsizmi?</p>
                        <p class="text-gray-500 mb-6">Aks holda video dars qaytadan boshlanadi!</p>
                        <p class="text-sm text-gray-400 mb-4" id="attention-timer">Javob vaqti: <span
                                id="timer-seconds">10</span>
                            soniya</p>
                        <button onclick="confirmAttention()"
                            class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-lg font-semibold rounded-2xl transition-all transform hover:scale-105 shadow-lg">
                            âœ“ Ha, ko'ryapman
                        </button>
                    </div>
                </div>
            </div>

            <!-- Success Modal (Moved outside for all video types) -->
            <div id="success-modal"
                class="absolute inset-0 bg-black/70 backdrop-blur-sm z-[80] hidden items-center justify-center">
                <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md mx-4">
                    <div class="text-center">
                        <div
                            class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Tabriklaymiz! ðŸŽ‰</h2>
                        <p class="text-gray-500 mb-6">Siz darsni muvaffaqiyatli tamomladingiz va barcha tekshiruvlardan
                            o'tdingiz
                        </p>
                        <div id="success-modal-next-lesson-info"
                            class="hidden mb-6 text-left p-4 bg-primary-50 rounded-2xl border border-primary-100">
                            <p class="text-xs font-semibold text-primary-600 uppercase tracking-wider mb-1">Keyingi
                                dars:
                            </p>
                            <p class="text-base font-bold text-gray-900 leading-tight" id="next-lesson-title"></p>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="window.location.reload();"
                                class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-colors">
                                Darsga qaytish
                            </button>
                            <div id="success-modal-next-lesson" class="hidden flex-1">
                                <a id="next-lesson-link" href="#"
                                    class="block w-full px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition-colors text-center shadow-md hover:shadow-lg">
                                    Keyingi dars â†’
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    @keyframes bounce-in {
        0% {
            transform: scale(0.5);
            opacity: 0;
        }

        50% {
            transform: scale(1.05);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .animate-bounce-in {
        animation: bounce-in 0.4s ease-out;
    }

    #video-container {
        position: relative;
    }



    #custom-controls,
    #youtube-custom-controls {
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 10;
    }

    #video-container:hover #custom-controls,
    .aspect-video:hover #youtube-custom-controls {
        opacity: 1;
    }

    #custom-controls button,
    #youtube-custom-controls button {
        cursor: pointer;
    }

    #custom-controls button:hover,
    #youtube-custom-controls button:hover {
        transform: scale(1.1);
    }
</style>

<script>
    const IS_STUDENT = {{ 'true' if current_user.role == 'student' else 'false' }};
    const lessonId = {{ lesson.id }};

    // Global Elements
    const videoPlayer = document.getElementById('video-player');
    const youtubePlayer = document.getElementById('youtube-player');

    // Global State
    let youtubeAPI = null;
    let videoDuration = 0;

    // Student State
    let checksPassedFromServer = {{ lesson_view.attention_checks_passed if lesson_view else 0 }};
    let isCompleted = {{ 'true' if lesson_view and lesson_view.is_completed else 'false' }};
    let maxWatchedTime = {{ lesson_view.watch_duration if lesson_view else 0 }};

    let checkTimes = [];
    let checksTriggered = [false, false, false];
    let attentionTimer = null;
    let timerSeconds = 10;
    let currentTime = 0;
    let lastValidTime = 0;
    let nextLessonInfo = null;

    function openVideoModal() {
        const modal = document.getElementById('video-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';

        setTimeout(() => {
            if (videoPlayer) {
                videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
            }
            if (youtubeAPI && typeof youtubeAPI.playVideo === 'function') {
                try { youtubeAPI.playVideo(); } catch (e) { }
            }
        }, 300);
    }

    function closeVideoModal() {
        const modal = document.getElementById('video-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';

        if (videoPlayer) videoPlayer.pause();
        if (youtubeAPI && typeof youtubeAPI.pauseVideo === 'function') {
            try { youtubeAPI.pauseVideo(); } catch (e) { }
        }

        // Exit fullscreen if closed
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(e => console.log(e));
        }
    }

    function toggleFullscreen() {
        const container = document.getElementById('video-container');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                alert(`Error: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    document.addEventListener('fullscreenchange', () => {
        const isFS = !!document.fullscreenElement;
        document.querySelectorAll('#fullscreen-icon, #youtube-fullscreen-icon').forEach(el => el.classList.toggle('hidden', isFS));
        document.querySelectorAll('#exit-fullscreen-icon, #youtube-exit-fullscreen-icon').forEach(el => el.classList.toggle('hidden', !isFS));
    });

    // Disable Keyboard Seeking & Fullscreen
    document.addEventListener('keydown', function (e) {
        if (!IS_STUDENT) return;

        // Fullscreen block ('f') - only if not completed
        if (e.key.toLowerCase() === 'f') {
            return;
        }

        // Seeking block (Arrows, J, L, numbers 0-9) - only if not completed
        const blockedKeys = ['ArrowLeft', 'ArrowRight', 'j', 'J', 'l', 'L', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        if (blockedKeys.includes(e.key) && !isCompleted) {
            e.preventDefault();
            e.stopPropagation();
        }
    }, true);

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // --- Tracking & Checks (Student Only) ---

    document.addEventListener('visibilitychange', function () {
        if (document.hidden && IS_STUDENT && !isCompleted) {
            if (videoPlayer) videoPlayer.pause();
            if (youtubeAPI && typeof youtubeAPI.pauseVideo === 'function') {
                try { youtubeAPI.pauseVideo(); } catch (e) { }
            }
        }
    });

    function initializeChecks(duration) {
        if (!IS_STUDENT || duration <= 0) return;
        videoDuration = duration;
        checkTimes = [duration * 0.25, duration * 0.50, duration * 0.70]; // 70% for reliability on short videos
    }

    function showAttentionModal() {
        if (document.getElementById('attention-modal').classList.contains('flex')) return;

        const modal = document.getElementById('attention-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        if (videoPlayer) videoPlayer.pause();
        if (youtubeAPI && typeof youtubeAPI.pauseVideo === 'function') youtubeAPI.pauseVideo();

        timerSeconds = 10;
        updateTimerDisplay();
        attentionTimer = setInterval(() => {
            timerSeconds--;
            updateTimerDisplay();
            if (timerSeconds <= 0) {
                clearInterval(attentionTimer);
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                // Penalize: Reset to previous milestone
                let resetTime = 0;
                if (checksPassedFromServer === 1) resetTime = checkTimes[0] || 0;
                if (checksPassedFromServer === 2) resetTime = checkTimes[1] || 0;

                // Reset trigger flags for failed and future checks so they can trigger again
                checksTriggered = checksTriggered.map((t, idx) => idx < checksPassedFromServer);

                maxWatchedTime = resetTime;
                lastValidTime = resetTime;

                if (videoPlayer) {
                    videoPlayer.currentTime = resetTime;
                    videoPlayer.pause();
                }
                if (youtubeAPI && typeof youtubeAPI.seekTo === 'function') {
                    youtubeAPI.seekTo(resetTime, true);
                    youtubeAPI.pauseVideo();
                }

                alert("Siz diqqat tekshiruvidan o'ta olmadingiz!");
                window.location.reload();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const el = document.getElementById('timer-seconds');
        if (el) el.textContent = timerSeconds;
    }

    function confirmAttention() {
        clearInterval(attentionTimer);
        const modal = document.getElementById('attention-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/subjects/lessons/${lessonId}/attention-check`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    checksPassedFromServer = data.checks_passed;
                    document.querySelectorAll('#check-counter, #check-counter-modal').forEach(el => el.textContent = `${checksPassedFromServer}/3`);

                    const progressBar = document.getElementById('check-progress-bar');
                    if (progressBar) progressBar.style.width = `${(checksPassedFromServer / 3) * 100}%`;

                    if (data.is_completed) {
                        isCompleted = true;
                        nextLessonInfo = data.next_lesson;
                        document.querySelectorAll('#completion-badge, #completion-badge-modal').forEach(el => { el.classList.remove('hidden'); el.classList.add('flex'); });
                    }
                }
            });

        if (videoPlayer) videoPlayer.play();
        if (youtubeAPI && typeof youtubeAPI.playVideo === 'function') youtubeAPI.playVideo();
    }

    function showSuccessModal() {
        const modal = document.getElementById('success-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('success-modal-next-lesson').classList.add('hidden');
    }

    function showSuccessModalWithNext(nextLesson) {
        const modal = document.getElementById('success-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('success-modal-next-lesson').classList.remove('hidden');
        document.getElementById('success-modal-next-lesson-info').classList.remove('hidden');
        document.getElementById('next-lesson-title').textContent = nextLesson.title;
        document.getElementById('next-lesson-link').href = nextLesson.url;
    }

    function closeSuccessModal() {
        const modal = document.getElementById('success-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Progress Syncing
    function syncProgress(time) {
        if (!IS_STUDENT || isCompleted) return;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch(`/subjects/lessons/${lessonId}/update-watch-time`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ watch_duration: Math.floor(time) })
        }).then(r => r.json()).then(d => {
            if (d.success) maxWatchedTime = Math.max(maxWatchedTime, d.watch_duration);
        });
    }

    // --- Native Video Handling ---
    if (videoPlayer) {
        videoPlayer.addEventListener('loadedmetadata', () => {
            initializeChecks(videoPlayer.duration);
            const totalTimeEl = document.getElementById('total-time');
            if (totalTimeEl) totalTimeEl.textContent = formatTime(videoPlayer.duration);

            if (IS_STUDENT && isCompleted) {
                const controls = document.getElementById('custom-controls');
                if (controls) controls.remove();
                videoPlayer.setAttribute('controls', '');
            }
        });

        if (IS_STUDENT) {
            videoPlayer.addEventListener('timeupdate', () => {
                const now = videoPlayer.currentTime;

                // Block seeking forward (Reduced buffer for strictness)
                if (!isCompleted && now > maxWatchedTime + 2) {
                    videoPlayer.currentTime = lastValidTime;
                } else {
                    lastValidTime = now;
                    if (now > maxWatchedTime) maxWatchedTime = now;
                }

                // Update UI
                const pb = document.getElementById('progress-bar');
                if (pb) pb.style.width = (Math.min(now, maxWatchedTime) / videoDuration * 100) + '%';
                const ct = document.getElementById('current-time');
                if (ct) ct.textContent = formatTime(now);

                // Checks
                if (!isCompleted) {
                    for (let i = 0; i < 3; i++) {
                        if (i >= checksPassedFromServer && !checksTriggered[i] && checkTimes[i] && now >= checkTimes[i]) {
                            checksTriggered[i] = true;
                            showAttentionModal();
                            break;
                        }
                    }
                }
            });

            const playPauseBtn = document.getElementById('play-pause-btn');
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', () => {
                    if (videoPlayer.paused) videoPlayer.play();
                    else videoPlayer.pause();
                });
            }
            videoPlayer.addEventListener('play', () => {
                document.getElementById('play-icon')?.classList.add('hidden');
                document.getElementById('pause-icon')?.classList.remove('hidden');
            });
            videoPlayer.addEventListener('pause', () => {
                document.getElementById('play-icon')?.classList.remove('hidden');
                document.getElementById('pause-icon')?.classList.add('hidden');
            });

            const volumeBtn = document.getElementById('volume-btn');
            if (volumeBtn) {
                volumeBtn.addEventListener('click', () => {
                    videoPlayer.muted = !videoPlayer.muted;
                    document.getElementById('volume-on-icon')?.classList.toggle('hidden', videoPlayer.muted);
                    document.getElementById('volume-off-icon')?.classList.toggle('hidden', !videoPlayer.muted);
                });
            }

            videoPlayer.addEventListener('ended', () => {
                if (IS_STUDENT && checksPassedFromServer >= 3) {
                    if (nextLessonInfo) showSuccessModalWithNext(nextLessonInfo);
                    else showSuccessModal();
                }
            });

            // Click to Play/Pause
            videoPlayer.addEventListener('click', () => {
                if (videoPlayer.paused) videoPlayer.play();
                else videoPlayer.pause();
            });

            setInterval(() => {
                if (!videoPlayer.paused) syncProgress(videoPlayer.currentTime);
            }, 30000);
        }
    }

    // --- YouTube Handling ---
    if (youtubePlayer) {
        if (!window.YT) {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);
        }

        window.onYouTubeIframeAPIReady = () => {
            youtubeAPI = new YT.Player('youtube-player', {
                events: {
                    'onReady': (e) => {
                        const dur = e.target.getDuration();
                        initializeChecks(dur);
                        const tt = document.getElementById('youtube-total-time');
                        if (tt) tt.textContent = formatTime(dur);

                        if (dur > 0) {
                            setInterval(trackYouTube, 500);
                            if (IS_STUDENT) setInterval(() => {
                                if (youtubeAPI.getPlayerState() === YT.PlayerState.PLAYING) syncProgress(youtubeAPI.getCurrentTime());
                            }, 30000);
                        }
                    },
                    'onStateChange': (e) => {
                        const playIcon = document.getElementById('youtube-play-icon');
                        const pauseIcon = document.getElementById('youtube-pause-icon');
                        if (e.data === YT.PlayerState.PLAYING) {
                            playIcon?.classList.add('hidden');
                            pauseIcon?.classList.remove('hidden');
                        } else {
                            playIcon?.classList.remove('hidden');
                            pauseIcon?.classList.add('hidden');
                        }

                        if (e.data === YT.PlayerState.ENDED && IS_STUDENT && checksPassedFromServer >= 3) {
                            if (nextLessonInfo) showSuccessModalWithNext(nextLessonInfo);
                            else showSuccessModal();
                        }
                    }
                }
            });
        };

        function trackYouTube() {
            if (!youtubeAPI || typeof youtubeAPI.getCurrentTime !== 'function') return;
            const now = youtubeAPI.getCurrentTime();

            if (IS_STUDENT && !isCompleted) {
                if (now > maxWatchedTime + 2) {
                    youtubeAPI.seekTo(lastValidTime, true);
                } else {
                    lastValidTime = now;
                    if (now > maxWatchedTime) maxWatchedTime = now;
                }

                // Checks
                for (let i = 0; i < 3; i++) {
                    if (i >= checksPassedFromServer && !checksTriggered[i] && checkTimes[i] && now >= checkTimes[i]) {
                        checksTriggered[i] = true;
                        youtubeAPI.pauseVideo();
                        showAttentionModal();
                        break;
                    }
                }
            }

            // UI
            const pb = document.getElementById('youtube-progress-bar');
            if (pb) pb.style.width = (Math.min(now, maxWatchedTime) / videoDuration * 100) + '%';
            const ct = document.getElementById('youtube-current-time');
            if (ct) ct.textContent = formatTime(now);
        }

        function toggleYouTubePlay() {
            if (!youtubeAPI || typeof youtubeAPI.getPlayerState !== 'function') return;
            const state = youtubeAPI.getPlayerState();
            if (state === YT.PlayerState.PLAYING) youtubeAPI.pauseVideo();
            else youtubeAPI.playVideo();
        }

        const ytPlayBtn = document.getElementById('youtube-play-pause-btn');
        if (ytPlayBtn) {
            ytPlayBtn.addEventListener('click', () => {
                const state = youtubeAPI.getPlayerState();
                if (state === YT.PlayerState.PLAYING) youtubeAPI.pauseVideo();
                else youtubeAPI.playVideo();
            });
        }

        const ytVolBtn = document.getElementById('youtube-volume-btn');
        if (ytVolBtn) {
            ytVolBtn.addEventListener('click', () => {
                if (youtubeAPI.isMuted()) {
                    youtubeAPI.unMute();
                    document.getElementById('youtube-volume-on-icon')?.classList.remove('hidden');
                    document.getElementById('youtube-volume-off-icon')?.classList.add('hidden');
                } else {
                    youtubeAPI.mute();
                    document.getElementById('youtube-volume-on-icon')?.classList.add('hidden');
                    document.getElementById('youtube-volume-off-icon')?.classList.remove('hidden');
                }
            });
        }
    }
</script>